name: Deploy to AWS EC2

on:
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° (GitHub Actions íƒ­ì—ì„œ ë²„íŠ¼ í´ë¦­)
    inputs:
      confirm:
        description: 'ë°°í¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes ì…ë ¥)'
        required: true
        default: 'no'

jobs:
  deploy:
    name: ğŸš€ Build & Deploy
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'

    steps:
      # â”€â”€â”€ 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€â”€ 2. zip ì••ì¶• ë° S3 ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Zip source & upload to S3
        run: |
          zip -r license-manager.zip . \
            --exclude "*.git*" \
            --exclude "node_modules/*" \
            --exclude ".next/*" \
            --exclude "*.env*"

          aws s3 cp license-manager.zip \
            s3://triplecomma-releases/triplecomma-backoffice/license-manager.zip

          echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ"

      # â”€â”€â”€ 3. EC2ì—ì„œ ë°°í¬ ì‹¤í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy on EC2 via SSM
        id: deploy
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "i-0aeda7845a9634718" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "echo \"=== [1/4] S3ì—ì„œ ì†ŒìŠ¤ì½”ë“œ ë‹¤ìš´ë¡œë“œ ===\"",
              "cd /home/ssm-user/app",
              "aws s3 cp s3://triplecomma-releases/triplecomma-backoffice/license-manager.zip .",
              "unzip -o license-manager.zip -d license-manager",
              "cd license-manager",
              "echo \"=== [2/4] ìŠ¤ì™‘ í™•ì¸ ===\"",
              "free -h",
              "if [ ! -f /swapfile ]; then sudo dd if=/dev/zero of=/swapfile bs=128M count=16 && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile && echo \"ìŠ¤ì™‘ ì„¤ì • ì™„ë£Œ\"; fi",
              "echo \"=== [3/4] Docker ì´ë¯¸ì§€ ë¹Œë“œ ===\"",
              "sudo docker build -t license-manager:new .",
              "echo \"=== [4/4] ì»¨í…Œì´ë„ˆ êµì²´ ===\"",
              "sudo docker tag license-manager:latest license-manager:backup 2>/dev/null || true",
              "sudo docker rm -f license-app || true",
              "sudo docker run -d --name license-app -p 8080:3000 -e DATABASE_URL=file:/app/dev.db -e NODE_ENV=production -e SECURE_COOKIE=false -v /home/ssm-user/license-manager/data/dev.db:/app/dev.db license-manager:new",
              "sudo docker tag license-manager:new license-manager:latest",
              "echo \"ë°°í¬ ì™„ë£Œ\""
            ]' \
            --timeout-seconds 600 \
            --query 'Command.CommandId' \
            --output text)

          echo "COMMAND_ID=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM ëª…ë ¹ ID: $COMMAND_ID"

      - name: Wait for deployment to complete
        run: |
          COMMAND_ID="${{ steps.deploy.outputs.COMMAND_ID }}"
          echo "ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."

          for i in $(seq 1 24); do
            sleep 15
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "i-0aeda7845a9634718" \
              --query 'Status' --output text 2>/dev/null || echo "Pending")

            echo "[$i/24] ìƒíƒœ: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "âœ… ë°°í¬ ì„±ê³µ"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "TimedOut" ] || [ "$STATUS" = "Cancelled" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "i-0aeda7845a9634718" \
                --query 'StandardErrorContent' --output text
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: $STATUS"
              exit 1
            fi
          done

          echo "âŒ ë°°í¬ íƒ€ì„ì•„ì›ƒ (6ë¶„ ì´ˆê³¼)"
          exit 1

      # â”€â”€â”€ 4. QA ìë™í™” (EC2 ë‚´ë¶€ localhostë¡œ ì‹¤í–‰, íì‡„ë§ ëŒ€ì‘) â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run QA checks via SSM
        id: qa
        run: |
          QA_COMMAND_ID=$(aws ssm send-command \
            --instance-ids "i-0aeda7845a9634718" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "BASE_URL=http://localhost:8080",
              "FAIL=0",
              "echo \"=== QA ì‹œì‘ ===\"",
              "for i in 1 2 3 4 5 6; do STATUS=$(curl -s -o /dev/null -w \"%{http_code}\" $BASE_URL/login || echo 000); if [ \"$STATUS\" = \"200\" ]; then echo \"ì•± ì¤€ë¹„ë¨\"; break; fi; echo \"[$i/6] ëŒ€ê¸°... ($STATUS)\"; sleep 5; done",
              "STATUS=$(curl -s -o /dev/null -w \"%{http_code}\" $BASE_URL/login); if [ \"$STATUS\" = \"200\" ]; then echo \"PASS /login\"; else echo \"FAIL /login $STATUS\"; FAIL=1; fi",
              "STATUS=$(curl -s -o /dev/null -w \"%{http_code}\" -X POST $BASE_URL/api/auth/login -H \"Content-Type: application/json\" -d \"{\\\"username\\\":\\\"admin\\\",\\\"password\\\":\\\"admin123\\\"}\"); if [ \"$STATUS\" = \"200\" ]; then echo \"PASS POST /api/auth/login\"; else echo \"FAIL POST /api/auth/login $STATUS\"; FAIL=1; fi",
              "COOKIE=$(curl -s -i -X POST $BASE_URL/api/auth/login -H \"Content-Type: application/json\" -d \"{\\\"username\\\":\\\"admin\\\",\\\"password\\\":\\\"admin123\\\"}\" | grep -i set-cookie | grep session_token | sed \"s/.*session_token=//;s/;.*//\")",
              "for PAGE in / /licenses /employees /settings/import; do STATUS=$(curl -s -o /dev/null -w \"%{http_code}\" -H \"Cookie: session_token=$COOKIE\" $BASE_URL$PAGE); if [ \"$STATUS\" = \"200\" ]; then echo \"PASS $PAGE\"; else echo \"FAIL $PAGE $STATUS\"; FAIL=1; fi; done",
              "for API in /api/licenses /api/employees; do STATUS=$(curl -s -o /dev/null -w \"%{http_code}\" -H \"Cookie: session_token=$COOKIE\" $BASE_URL$API); if [ \"$STATUS\" = \"200\" ]; then echo \"PASS $API\"; else echo \"FAIL $API $STATUS\"; FAIL=1; fi; done",
              "echo \"=== QA ì™„ë£Œ ===\"",
              "if [ \"$FAIL\" = \"1\" ]; then echo \"QA_RESULT=FAIL\"; exit 1; else echo \"QA_RESULT=PASS\"; fi"
            ]' \
            --timeout-seconds 120 \
            --query 'Command.CommandId' \
            --output text)

          for i in $(seq 1 12); do
            sleep 10
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$QA_COMMAND_ID" \
              --instance-id "i-0aeda7845a9634718" \
              --query 'Status' --output text 2>/dev/null || echo "Pending")

            echo "[$i/12] QA ìƒíƒœ: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$QA_COMMAND_ID" \
                --instance-id "i-0aeda7845a9634718" \
                --query 'StandardOutputContent' --output text
              echo "âœ… QA ì „ì²´ í†µê³¼"
              exit 0
            elif [ "$STATUS" = "Failed" ]; then
              aws ssm get-command-invocation \
                --command-id "$QA_COMMAND_ID" \
                --instance-id "i-0aeda7845a9634718" \
                --query 'StandardOutputContent' --output text
              echo "âŒ QA ì‹¤íŒ¨"
              exit 1
            fi
          done

          echo "âŒ QA íƒ€ì„ì•„ì›ƒ"
          exit 1

      # â”€â”€â”€ 5. ë¡¤ë°± (QA ë˜ëŠ” ë°°í¬ ì‹¤íŒ¨ ì‹œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âš ï¸ ì‹¤íŒ¨ ê°ì§€ â€” ë¡¤ë°± ì‹œë„ ì¤‘..."

          aws ssm send-command \
            --instance-ids "i-0aeda7845a9634718" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "if sudo docker images | grep -q license-manager.*backup; then sudo docker rm -f license-app || true && sudo docker run -d --name license-app -p 8080:3000 -e DATABASE_URL=file:/app/dev.db -e NODE_ENV=production -e SECURE_COOKIE=false -v /home/ssm-user/license-manager/data/dev.db:/app/dev.db license-manager:backup && echo \"ë¡¤ë°± ì™„ë£Œ\"; else echo \"ë°±ì—… ì´ë¯¸ì§€ ì—†ìŒ â€” ë¡¤ë°± ë¶ˆê°€\"; fi"
            ]' \
            --timeout-seconds 60 || true

      # â”€â”€â”€ 6. Slack ì•Œë¦¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Slack ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "âœ… *license-manager ë°°í¬ ì„±ê³µ*",
              "attachments": [{
                "color": "good",
                "fields": [
                  { "title": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "short": true },
                  { "title": "ë°°í¬ì", "value": "${{ github.actor }}", "short": true },
                  { "title": "ì»¤ë°‹", "value": "${{ github.sha }}", "short": false },
                  { "title": "QA", "value": "ì „ì²´ í†µê³¼ âœ…", "short": true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Slack ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "âŒ *license-manager ë°°í¬ ì‹¤íŒ¨ â€” ë¡¤ë°±ë¨*",
              "attachments": [{
                "color": "danger",
                "fields": [
                  { "title": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "short": true },
                  { "title": "ë°°í¬ì", "value": "${{ github.actor }}", "short": true },
                  { "title": "ì»¤ë°‹", "value": "${{ github.sha }}", "short": false },
                  { "title": "Actions ë¡œê·¸", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
